---
layout: 	post
title: 		"第一课、OllyDbg常用断点"
subtitle:	" \"学习《加密与解密第一课》的心得\""
date:		2019-02-26 23:34:00
author:		"duwanjiang"
header-img:	"img/post-bg-rwd.jpg"
catalog: true
categories: 破解
tags:
    - OllyDbg
---

> “破解是我的梦想，我要一步步实现我的梦想 ”

#  1、INT3 断点
INT3断点是通过在汇编指令中将下断地址写入0xCC指令，当被调试进程执行INT3指令时导致一个异常时，调试器就会捕获这个异常，从而停止在断点处。 
*    这是一个常用的断点，在OD中使用bp命令或者“F2”快捷键来设置/取消断点。

# 2、硬件断点
硬件断点和DRx调试寄存器有关，DRx调试寄存器共有8个（DR0-DR7），硬件断点的原理是使用DR0-DR3设置地址，并使用DR7设置状态，所以最多设置4个断点。
*   设置硬件断点的快捷键是“F4”

# 3、内存断点
OD可以设置内存访问或写入断点，原理是对所设的地址赋予补课访问/不可写属性，这样当访问/写入的时候就会产生异常。OD捕获异常后，比较异常地址是不是断点地址，如果是就中断，让用户继续操作。
*  设置内存断点的方式为：在数据窗口中，对需要下内存断点地方点击鼠标右键，选择“breakpoint --》 Memory,on write”（“断点”--》“内存写入”）命令。

# 4、内存访问一次性断点
windows对内存使用段页式的管理方式。在OD里按**“Alt+M”**快捷键显示内存，可以看到许多个段，每个段都有不可访问、读、写、执行属性。在相应的段上单击右键，如下图，会在快捷菜单中发现一个命令“在访问上设置断点”，快捷键是“F2”，用于对整个内存块设置该类断点。这个断点是一次性断点，当所在段被读取或执行时就会中断。如果想捕获调用或返回某个模块，该类断点就非常有用了。

![]({{site.url}}/img/posts_img/technology/crack/OllyDbg常用断点/6.png)

# 5、消息断点
Windows本身是由消息驱动的，如果调试时没有合适的断点，可以尝试使用消息断点，当某个特定窗口函数接受到某个特定消息时，消息断点将使程序中断。
* 消息断点与INT3断点的区别在于：INT3断点可以在程序启动之前设置，消息断点只有在窗口被创建之后才能被设置并拦截消息。
* 断点设置方法：点击菜单“查看”--》“窗口” 或工具栏中的“W”按钮，列出窗口相关参数，如下图：

![]({{site.url}}/img/posts_img/technology/crack/OllyDbg常用断点/3.png)
![]({{site.url}}/img/posts_img/technology/crack/OllyDbg常用断点/2.png)

# 6、条件断点
在调试过程中，我们经常希望断点在满足一定条件时才会中断，这类断点称为条件断点。OD的条件断点可以按寄存器、存储器、消息等设断。条件断点是一个带有条件表达式的普通INT3断点。
* 设置条件断点方法：快捷键为“Shift + F2”

## （1）按寄存器条件中断
在程序的某个地址如：0x00401476h处，打开了条件断点后，在条件文本框中输入表达式“eax==0400000”。这样，程序在执行到 0x00401476h处时，当eax的值为 0400000h，OD将会中断。

* 可以输入命令行命令：`` bp  401476 eax==0400000``

## （2）按存储器条件中断
这里以CreateFileA函数举例，当我们打开测试程序看到，程序的第一个参数是FileName，此时我们在CreateFileA函数内部下FileName=“c:\\1212.txt”的条件断点，如下图，其中**“[esp+4]”** 是获取函数第一个参数的内存地址，如果要获取参数地址所向的字符串，就必须使用**“[[esp+4]]”**。我们将光标移动到CreateFileA函数的第一行，按下快捷键"Shift + F2" ，输入 “[STRING [esp + 4]]=="c:\\1212.txt"”（STRING 前缀在OD中解释是：“以零结尾的ASCII字符串”）

![]({{site.url}}/img/posts_img/technology/crack/OllyDbg常用断点/1.png)

* 可以通过输入如下命令下断点： 
  ``bp CreateFileA,[STRING [esp+4]]=="c:\\1212.txt"``
* 如果是Unicode字符串，可以输入：
  ``bp CreateFileW,[UNICODE [esp+4]]=="c:\\1212.txt"``

# 7、条件记录断点
条件记录断点除了具有条件断点的作用，还能记录断点处函数表达式或参数的值。也可以设置通过断点的次数，每次符合暂停条件时，计数器的值都将减1。

通过下图设置条件记录断点，其中：
1. 条件：是程序暂停的条件
2. 说明：是对表达式值的一个说明
3. 表达式：是指程序中断时需要打印的值，一次只能打印一个值
4. 解码表达式的值为：用于解析表达式的值的方法，如果你表达式写的是"[esp + 4]"，那你就要在下拉框中选择“Pointer to ASCII String（指向ASCII字符串的指针）”，才能得到地址的值，相当于“[STRING [esp+4]]”的效果。
5. 暂停程序：用于在断点满足条件时，是否暂停程序，以及配置暂停的次数，每暂停一次，后面的计数配置就会减1
6. 记录表达式的值：用于在断点满足条件时，日志面板记录表达式的值。
7. 记录函数参数：用于在断点满足条件时，日志面板记录函数的参数。
8. 命令插件窗：用于编写需要程序暂停时，需要执行的命令。

![]({{site.url}}/img/posts_img/technology/crack/OllyDbg常用断点/4.png)

下面是日志面板的情况：

![]({{site.url}}/img/posts_img/technology/crack/OllyDbg常用断点/5.png)

* 下条件记录断点的快捷键："Shift + F4"
* 打开日志面板的快捷键：“Alt + L”